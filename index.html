<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>QR Capture & Crop (OpenCV.js)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <style>
    :root {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      color-scheme: dark;
    }

    body {
      margin: 0;
      padding: 12px;
      background: #0b0b0b;
      color: #f5f5f5;
      display: flex;
      justify-content: center;
    }

    .container {
      width: 100%;
      max-width: 480px;
    }

    h2 {
      margin: 0 0 6px 0;
      font-size: 1.2rem;
      text-align: center;
    }

    p {
      margin: 0 0 10px 0;
      font-size: 0.9rem;
      text-align: center;
      color: #c2c2c2;
    }

    #video {
      width: 100%;
      height: auto;
      aspect-ratio: 4 / 3;
      background: #000;
      border-radius: 10px;
      overflow: hidden;
      display: block;
    }

    #controls {
      margin: 10px 0 14px 0;
      display: flex;
      flex-direction: column;
      gap: 8px;
      align-items: stretch;
    }

    .button-row {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    button {
      padding: 10px;
      font-size: 0.9rem;
      border-radius: 999px;
      border: none;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.2s, transform 0.1s;
      flex: 1;
      min-width: 0;
    }

    #captureBtn {
      background: #1e88e5;
      color: #fff;
    }

    #captureBtn:active {
      transform: scale(0.97);
      background: #1565c0;
    }

    #captureBtn:disabled {
      background: #555;
      cursor: default;
      transform: none;
    }

    #flashBtn {
      background: #333;
      color: #f5f5f5;
    }

    #flashBtn.enabled {
      background: #ffd54f;
      color: #000;
    }

    #flashBtn:active,
    #photoBtn:active {
      transform: scale(0.97);
    }

    #photoBtn {
      background: #4caf50;
      color: #fff;
    }

    #photoBtn:disabled {
      background: #555;
      cursor: default;
      transform: none;
    }

    /* NEW button styling */
    #base64Btn {
      background: #9c27b0;
      color: #fff;
    }

    #base64Btn:disabled {
      background: #555;
      cursor: default;
    }

    #status {
      font-size: 0.8rem;
      text-align: center;
      color: #bbbbbb;
      min-height: 1.2rem;
    }

    #tapHint {
      font-size: 0.75rem;
      text-align: center;
      color: #888;
    }

    #output {
      display: flex;
      flex-direction: column;
      gap: 12px;
      margin-top: 4px;
    }

    .panel {
      background: #151515;
      padding: 8px;
      border-radius: 10px;
    }

    .panel-title {
      font-size: 0.85rem;
      margin-bottom: 4px;
      color: #d0d0d0;
    }

    canvas {
      width: 100%;
      height: auto;
      border-radius: 8px;
      border: 1px solid #333;
      background: #000;
      display: block;
    }
  </style>
</head>

<body>
  <div class="container">
    <h2>QR Capture & Crop</h2>
    <p>Choose: live camera or take a photo, then process the QR.</p>

    <video id="video" autoplay playsinline></video>

    <div id="controls">
      <div class="button-row">
        <button id="captureBtn" disabled>Capture (Live)</button>
        <button id="flashBtn" disabled>Flash</button>
      </div>

      <div class="button-row">
        <button id="photoBtn">Use Photo / Take Photo</button>
      </div>

      <!-- NEW BUTTON -->
      <div class="button-row">
        <button id="base64Btn" disabled>Get Base64 (Full Clean Crop)</button>
      </div>

      <span id="status">Loading OpenCVâ€¦</span>
      <div id="tapHint">Tip: tap the video to refocus (if supported).</div>
    </div>

    <canvas id="hiddenCanvas" style="display:none;"></canvas>

    <input type="file" id="photoInput" accept="image/*" capture="environment" style="display:none;" />

    <div id="output">
      <div class="panel">
        <div class="panel-title">Full QR Crop (Siamese-clean)</div>
        <canvas id="qrFull"></canvas>
      </div>
      <div class="panel">
        <div class="panel-title">Center 36% Crop (Siamese-clean)</div>
        <canvas id="qrCenter"></canvas>
      </div>
      <div class="panel">
        <div class="panel-title">Straight QR (Siamese-clean)</div>
        <canvas id="qrStraight"></canvas>
      </div>
    </div>
  </div>

  <script async src="https://docs.opencv.org/4.x/opencv.js" onload="onOpenCvReady();"></script>

  <script>
    let video = document.getElementById("video");
    let hiddenCanvas = document.getElementById("hiddenCanvas");

    let qrFullCanvas = document.getElementById("qrFull");
    let qrCenterCanvas = document.getElementById("qrCenter");
    let qrStraightCanvas = document.getElementById("qrStraight");

    let captureBtn = document.getElementById("captureBtn");
    let flashBtn = document.getElementById("flashBtn");
    let photoBtn = document.getElementById("photoBtn");
    let base64Btn = document.getElementById("base64Btn");   // NEW
    let photoInput = document.getElementById("photoInput");
    let statusSpan = document.getElementById("status");

    let qrDetector = null;
    let streaming = false;
    let opencvReady = false;

    let videoTrack = null;
    let torchAvailable = false;
    let torchOn = false;
    let focusSupported = false;

    // NEW: generate Base64 from qrFull canvas
    base64Btn.addEventListener("click", () => {
      let canvas = qrFullCanvas;

      if (!canvas.width || !canvas.height) {
        alert("No cleaned crop available yet.");
        return;
      }

      let base64 = canvas.toDataURL("image/png");

      // Copy to clipboard
      navigator.clipboard.writeText(base64).catch(() => {});

      alert("Base64 copied to clipboard:\n\n" + base64.substring(0, 200) + "...");
    });

    // Camera startup
    function startCamera() {
      if (!navigator.mediaDevices?.getUserMedia) {
        console.warn("Camera not supported.");
        statusSpan.textContent = "Camera not supported.";
        captureBtn.disabled = true;
        flashBtn.disabled = true;
        return;
      }

      const constraints = {
        video: {
          facingMode: { ideal: "environment" },
          width: { ideal: 1920, max: 2560 },
          height: { ideal: 1080, max: 1440 }
        }
      };

      navigator.mediaDevices.getUserMedia(constraints).then(stream => {
        videoTrack = stream.getVideoTracks[0];
        video.srcObject = stream;
        video.play();
      });
    }

    function onOpenCvReady() {
      opencvReady = true;
      startCamera();

      video.addEventListener("playing", () => {
        if (streaming) return;
        streaming = true;

        hiddenCanvas.width = video.videoWidth;
        hiddenCanvas.height = video.videoHeight;

        qrDetector = new cv.QRCodeDetector();
        captureBtn.disabled = false;
      });

      captureBtn.addEventListener("click", captureFromVideo);
      flashBtn.addEventListener("click", toggleFlash);
      photoBtn.addEventListener("click", () => photoInput.click());
      photoInput.addEventListener("change", handlePhotoSelection);
    }

    // Torch toggle (unchanged)
    function toggleFlash() {}

    // Siamese-clean function
    function siameseClean(mat) {
      let blurred = new cv.Mat();
      let cleaned = new cv.Mat();

      cv.GaussianBlur(mat, blurred, new cv.Size(3,3), 0.3, 0.3, cv.BORDER_REFLECT_101);
      cv.normalize(blurred, cleaned, 0, 255, cv.NORM_MINMAX);

      blurred.delete();
      return cleaned;
    }

    // Main processing logic (unchanged except for enabling button)
    function processMat(src) {
      if (!qrDetector) qrDetector = new cv.QRCodeDetector();

      let points = new cv.Mat();
      let straight = new cv.Mat();

      let decoded = qrDetector.detectAndDecode(src, points, straight);

      if (decoded && decoded.length > 0 && !points.empty()) {
        let data = points.data32F;

        let xs = [data[0], data[2], data[4], data[6]];
        let ys = [data[1], data[3], data[5], data[7]];

        let xMin = parseInt(Math.min(...xs));
        let xMax = parseInt(Math.max(...xs));
        let yMin = parseInt(Math.min(...ys));
        let yMax = parseInt(Math.max(...ys));

        const pad = 4;
        xMin = Math.max(0, xMin - pad);
        yMin = Math.max(0, yMin - pad);
        xMax = Math.min(src.cols, xMax + pad);
        yMax = Math.min(src.rows, yMax + pad);

        let w = xMax - xMin;
        let h = yMax - yMin;

        if (w > 0 && h > 0) {
          let rect = new cv.Rect(xMin, yMin, w, h);
          let qrCrop = src.roi(rect);

          let qrClean = siameseClean(qrCrop);
          cv.imshow("qrFull", qrClean);

          // Enable new button
          base64Btn.disabled = false;

          qrClean.delete();
          qrCrop.delete();
        }
      }

      points.delete();
      straight.delete();
    }

    // Capture live
    function captureFromVideo() {
      const w = hiddenCanvas.width;
      const h = hiddenCanvas.height;

      let ctx = hiddenCanvas.getContext("2d");
      ctx.drawImage(video, 0, 0, w, h);

      let src = cv.imread(hiddenCanvas);
      let bgr = new cv.Mat();
      cv.cvtColor(src, bgr, cv.COLOR_RGBA2BGR);
      src.delete();

      processMat(bgr);
      bgr.delete();
    }

    // Capture photo file
    function handlePhotoSelection(e) {
      const file = e.target.files[0];
      if (!file) return;

      let img = new Image();
      let url = URL.createObjectURL(file);

      img.onload = () => {
        hiddenCanvas.width = img.width;
        hiddenCanvas.height = img.height;

        let ctx = hiddenCanvas.getContext("2d");
        ctx.drawImage(img, 0, 0);

        let src = cv.imread(hiddenCanvas);
        let bgr = new cv.Mat();
        cv.cvtColor(src, bgr, cv.COLOR_RGBA2BGR);
        src.delete();

        processMat(bgr);
        bgr.delete();

        URL.revokeObjectURL(url);
        photoInput.value = "";
      };

      img.src = url;
    }
  </script>
</body>
</html>
